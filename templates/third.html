<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>基金信号分析平台</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .fund-list { margin-top: 20px; }
        .group-section { margin-bottom: 30px; }
        .group-title { 
            background-color: #e9f5ff; 
            padding: 10px 15px; 
            border-radius: 4px; 
            margin-bottom: 15px;
            font-size: 16px;
            color: #0066cc;
        }
        .fund-item { 
            padding: 15px; 
            border-bottom: 1px solid #eee; 
            margin-bottom: 10px;
            display: flex; 
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .fund-left { flex: 1; min-width: 300px; }
        .fund-right { flex: 2; min-width: 600px; }
        .fund-item:hover { background-color: #f9f9f9; }
        .signal { padding: 5px 10px; border-radius: 3px; font-weight: bold; }
        .buy { background-color: #e6f7e9; color: #2a9d54; }
        .sell { background-color: #ffebe6; color: #d93025; }
        .watch { background-color: #fff8e6; color: #ff9800; }
        .none { background-color: #f0f0f0; color: #666; }
        .action-bar { margin: 20px 0; padding: 10px; background-color: #f0f8ff; display: flex; gap: 15px; align-items: center; }
        .export-btn, .clear-btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .export-btn { background-color: #007bff; color: white; }
        .export-btn:hover { background-color: #0056b3; }
        .clear-btn { background-color: #dc3545; color: white; }
        .clear-btn:hover { background-color: #bb2d3b; }
        .checkbox { width: 18px; height: 18px; cursor: pointer; margin-right: 10px; }
        .reason-text { color: #ff0000; margin-left: 15px; }
        .change-pct { 
            padding: 3px 8px; 
            border-radius: 3px; 
            font-weight: 500; 
            margin-right: 15px;
        }
        .rise { color: #d93025; background-color: #fff1f0; }
        .fall { color: #0f9d58; background-color: #e6f4ea; }
        .flat { color: #666; background-color: #f5f5f5; }
        .notes-container { 
            margin-top: 8px; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 4px;
            display: none;
        }
        .notes-input { 
            width: 100%; 
            padding: 8px; 
            box-sizing: border-box; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            min-height: 60px;
            resize: vertical;
        }
        .stat-info { display: flex; align-items: center; margin-bottom: 8px; }
        .threshold-label {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 10px;
            font-weight: 500;
        }
        .daily-threshold { background-color: #e6f7ff; color: #1890ff; }
        .consecutive-threshold { background-color: #fff0f0; color: #f5222d; }
        .both-threshold { background-color: #f6ffed; color: #52c41a; }
    </style>
</head>
<body>
    <div class="header">
        <h1>基金信号分析平台</h1>
        <p>实时展示超阈值基金数据及投资信号分析</p>
    </div>

    <div class="action-bar">
        <button class="export-btn" onclick="exportRecords()">导出操作记录</button>
        <button class="clear-btn" onclick="clearAllRecords()">清除所有记录</button>
        <span>已记录 <span id="recordedCount">0</span> 只基金</span>
    </div>

    <h2>超阈值基金列表</h2>
    <div class="fund-list" id="fundSignals">
        <p>加载中...</p>
    </div>

    <script>
        // 配置阈值参数（可根据需要调整）
        const THRESHOLDS = {
            dailyChange: 2,       // 单日涨跌幅阈值（百分比）
            consecutiveDays: 2    // 连续涨跌天数阈值
        };
        
        let operationRecords = JSON.parse(localStorage.getItem('fundNotes') || '{}');
        let allFunds = [];

        // 从接口获取数据
        fetch('/api/funds/signals')
            .then(response => {
                if (!response.ok) throw new Error("数据加载失败");
                return response.json();
            })
            .then(data => {
                allFunds = data;
                const thresholdFunds = filterAndSortFunds(data);
                renderFundList(thresholdFunds);
                updateRecordedCount();
            })
            .catch(error => {
                document.getElementById('fundSignals').innerHTML = `<p>错误：${error.message}</p>`;
            });

        // 筛选和排序逻辑：包含单日超阈值或连续超阈值的基金
        function filterAndSortFunds(funds) {
            // 1. 筛选超阈值基金：
            //    - 单日涨跌幅绝对值 >= 2%  或者
            //    - 连续涨跌天数 >= 2天
            const thresholdFunds = funds.filter(fund => 
                Math.abs(fund.daily_change_pct) >= THRESHOLDS.dailyChange || 
                fund.consecutive_days >= THRESHOLDS.consecutiveDays
            );
            
            // 2. 标记基金属于哪种超阈值类型
            thresholdFunds.forEach(fund => {
                const isDailyOver = Math.abs(fund.daily_change_pct) >= THRESHOLDS.dailyChange;
                const isConsecutiveOver = fund.consecutive_days >= THRESHOLDS.consecutiveDays;
                
                if (isDailyOver && isConsecutiveOver) {
                    fund.thresholdType = 'both'; // 同时超两个阈值
                } else if (isDailyOver) {
                    fund.thresholdType = 'daily'; // 仅单日超阈值
                } else {
                    fund.thresholdType = 'consecutive'; // 仅连续超阈值
                }
            });
            
            // 3. 排序逻辑：
            //    - 先按单日涨跌幅绝对值从大到小
            //    - 再按连续涨跌天数从大到小
            return thresholdFunds.sort((a, b) => {
                // 比较单日涨跌幅绝对值
                const absA = Math.abs(a.daily_change_pct);
                const absB = Math.abs(b.daily_change_pct);
                if (absA !== absB) {
                    return absB - absA; // 绝对值大的排在前面
                }
                
                // 单日涨跌幅相同则比较连续天数
                return b.consecutive_days - a.consecutive_days;
            });
        }

        // 渲染超阈值基金列表
        function renderFundList(thresholdFunds) {
            const container = document.getElementById('fundSignals');
            container.innerHTML = '';

            if (thresholdFunds.length > 0) {
                const section = document.createElement('div');
                section.className = 'group-section';
                section.innerHTML = `<div class="group-title">
                    📊 超阈值基金（${thresholdFunds.length}只）
                    <span style="font-size:14px; margin-left:10px;">
                        阈值：单日${THRESHOLDS.dailyChange}% / 连续${THRESHOLDS.consecutiveDays}天
                    </span>
                </div>`;
                
                thresholdFunds.forEach(fund => {
                    section.appendChild(createFundItem(fund));
                });
                container.appendChild(section);
            } else {
                container.innerHTML = '<p>暂无超阈值的基金数据</p>';
            }
        }

        // 创建单个基金项
        function createFundItem(fund) {
            const isRecorded = !!operationRecords[fund.code];
            const notes = operationRecords[fund.code]?.notes || '';

            // 涨跌样式
            let changeClass = 'flat';
            if (fund.daily_change_pct > 0) changeClass = 'rise';
            else if (fund.daily_change_pct < 0) changeClass = 'fall';

            // 超阈值标签样式
            let thresholdLabel = '';
            if (fund.thresholdType === 'daily') {
                thresholdLabel = '<span class="threshold-label daily-threshold">单日超阈值</span>';
            } else if (fund.thresholdType === 'consecutive') {
                thresholdLabel = '<span class="threshold-label consecutive-threshold">连续超阈值</span>';
            } else {
                thresholdLabel = '<span class="threshold-label both-threshold">双超阈值</span>';
            }

            const item = document.createElement('div');
            item.className = 'fund-item';
            item.innerHTML = `
                <!-- 左侧：基金基本信息 -->
                <div class="fund-left">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" class="checkbox" data-code="${fund.code}" ${isRecorded ? 'checked' : ''}
                            onchange="toggleNotes('${fund.code}')">
                        <strong>${fund.name}</strong>
                    </div>
                </div>

                <!-- 右侧：涨跌幅、连续天数、理由和操作区 -->
                <div class="fund-right">
                    <div class="stat-info">
                        <span class="change-pct ${changeClass}">${fund.daily_change_pct.toFixed(2)}%</span>
                   
                        <span class="reason-text">${fund.reasons}</span>
                    </div>
                    
                    <!-- 备注区域 -->
                    <div class="notes-container" id="notes-${fund.code}" style="display: ${isRecorded ? 'block' : 'none'}">
                        <textarea class="notes-input" placeholder="请输入操作思考...">${notes}</textarea>
                    </div>
                </div>
            `;
            
            // 添加自动保存事件监听
            const notesInput = item.querySelector(`#notes-${fund.code} .notes-input`);
            notesInput.addEventListener('input', () => {
                saveNotes(fund.code);
            });
            
            return item;
        }

        // 切换备注显示/隐藏
        function toggleNotes(fundCode) {
            const notesContainer = document.getElementById(`notes-${fundCode}`);
            const isChecked = document.querySelector(`.checkbox[data-code="${fundCode}"]`).checked;
            
            if (isChecked) {
                notesContainer.style.display = 'block';
                if (!operationRecords[fundCode]) {
                    const fund = allFunds.find(f => f.code === fundCode);
                    operationRecords[fundCode] = {
                        name: fund.name,
                        notes: '',
                        date: new Date().toLocaleDateString()
                    };
                }
            } else {
                notesContainer.style.display = 'none';
            }
            updateRecordedCount();
            saveToLocalStorage();
        }

        // 自动保存备注
        function saveNotes(fundCode) {
            const notes = document.querySelector(`#notes-${fundCode} .notes-input`).value;
            if (operationRecords[fundCode]) {
                operationRecords[fundCode].notes = notes;
                operationRecords[fundCode].date = new Date().toLocaleDateString();
                saveToLocalStorage();
            }
        }

        // 保存到本地存储
        function saveToLocalStorage() {
            localStorage.setItem('fundNotes', JSON.stringify(operationRecords));
            updateRecordedCount();
        }

        // 更新记录数量
        function updateRecordedCount() {
            document.getElementById('recordedCount').textContent = Object.keys(operationRecords).length;
        }

        // 导出记录
        function exportRecords() {
            if (Object.keys(operationRecords).length === 0) {
                alert("没有可导出的记录");
                return;
            }

            const today = new Date().toLocaleDateString();
            let content = `===== 基金操作记录（${today}）=====\n\n`;
            
            Object.values(operationRecords).forEach(record => {
                content += `1. ${record.name}\n`;
                content += `   操作：${record.notes || '无'}\n\n`;
            });

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `基金操作记录_${today.replace(/\//g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 清除所有记录
        function clearAllRecords() {
            if (confirm("确定要清除所有记录吗？")) {
                operationRecords = {};
                localStorage.removeItem('fundNotes');
                const thresholdFunds = filterAndSortFunds(allFunds);
                renderFundList(thresholdFunds);
                updateRecordedCount();
            }
        }
    </script>
</body>
</html>
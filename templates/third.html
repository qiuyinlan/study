<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>åŸºé‡‘ä¿¡å·åˆ†æå¹³å°</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .fund-list { margin-top: 20px; }
        .group-section { margin-bottom: 30px; }
        .group-title { 
            background-color: #e9f5ff; 
            padding: 10px 15px; 
            border-radius: 4px; 
            margin-bottom: 15px;
            font-size: 16px;
            color: #0066cc;
        }
        .fund-item { 
            padding: 15px; 
            border-bottom: 1px solid #eee; 
            margin-bottom: 10px;
            display: flex; 
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .fund-left { flex: 1; min-width: 300px; }
        .fund-right { flex: 2; min-width: 600px; }
        .fund-item:hover { background-color: #f9f9f9; }
        .signal { padding: 5px 10px; border-radius: 3px; font-weight: bold; }
        .buy { background-color: #e6f7e9; color: #2a9d54; }
        .sell { background-color: #ffebe6; color: #d93025; }
        .watch { background-color: #fff8e6; color: #ff9800; }
        .none { background-color: #f0f0f0; color: #666; }
        .action-bar { margin: 20px 0; padding: 10px; background-color: #f0f8ff; display: flex; gap: 15px; align-items: center; }
        .export-btn, .clear-btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .export-btn { background-color: #007bff; color: white; }
        .export-btn:hover { background-color: #0056b3; }
        .clear-btn { background-color: #dc3545; color: white; }
        .clear-btn:hover { background-color: #bb2d3b; }
        .checkbox { width: 18px; height: 18px; cursor: pointer; margin-right: 10px; }
        .reason-text { color: #ff0000; margin-left: 15px; }
        .change-pct { 
            padding: 3px 8px; 
            border-radius: 3px; 
            font-weight: 500; 
            margin-right: 15px;
        }
        .rise { color: #d93025; background-color: #fff1f0; }
        .fall { color: #0f9d58; background-color: #e6f4ea; }
        .flat { color: #666; background-color: #f5f5f5; }
        .notes-container { 
            margin-top: 8px; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 4px;
            display: none;
        }
        .notes-input { 
            width: 100%; 
            padding: 8px; 
            box-sizing: border-box; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            min-height: 60px;
            resize: vertical;
        }
        .stat-info { display: flex; align-items: center; margin-bottom: 8px; }
        .threshold-label {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 10px;
            font-weight: 500;
        }
        .daily-threshold { background-color: #e6f7ff; color: #1890ff; }
        .consecutive-threshold { background-color: #fff0f0; color: #f5222d; }
        .both-threshold { background-color: #f6ffed; color: #52c41a; }
    </style>
</head>
<body>
    <div class="header">
        <h1>åŸºé‡‘ä¿¡å·åˆ†æå¹³å°</h1>
        <p>å®æ—¶å±•ç¤ºè¶…é˜ˆå€¼åŸºé‡‘æ•°æ®åŠæŠ•èµ„ä¿¡å·åˆ†æ</p>
    </div>

    <div class="action-bar">
        <button class="export-btn" onclick="exportRecords()">å¯¼å‡ºæ“ä½œè®°å½•</button>
        <button class="clear-btn" onclick="clearAllRecords()">æ¸…é™¤æ‰€æœ‰è®°å½•</button>
        <span>å·²è®°å½• <span id="recordedCount">0</span> åªåŸºé‡‘</span>
    </div>

    <h2>è¶…é˜ˆå€¼åŸºé‡‘åˆ—è¡¨</h2>
    <div class="fund-list" id="fundSignals">
        <p>åŠ è½½ä¸­...</p>
    </div>

    <script>
        // é…ç½®é˜ˆå€¼å‚æ•°ï¼ˆå¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼‰
        const THRESHOLDS = {
            dailyChange: 2,       // å•æ—¥æ¶¨è·Œå¹…é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰
            consecutiveDays: 2    // è¿ç»­æ¶¨è·Œå¤©æ•°é˜ˆå€¼
        };
        
        let operationRecords = JSON.parse(localStorage.getItem('fundNotes') || '{}');
        let allFunds = [];

        // ä»æ¥å£è·å–æ•°æ®
        fetch('/api/funds/signals')
            .then(response => {
                if (!response.ok) throw new Error("æ•°æ®åŠ è½½å¤±è´¥");
                return response.json();
            })
            .then(data => {
                allFunds = data;
                const thresholdFunds = filterAndSortFunds(data);
                renderFundList(thresholdFunds);
                updateRecordedCount();
            })
            .catch(error => {
                document.getElementById('fundSignals').innerHTML = `<p>é”™è¯¯ï¼š${error.message}</p>`;
            });

        // ç­›é€‰å’Œæ’åºé€»è¾‘ï¼šåŒ…å«å•æ—¥è¶…é˜ˆå€¼æˆ–è¿ç»­è¶…é˜ˆå€¼çš„åŸºé‡‘
        function filterAndSortFunds(funds) {
            // 1. ç­›é€‰è¶…é˜ˆå€¼åŸºé‡‘ï¼š
            //    - å•æ—¥æ¶¨è·Œå¹…ç»å¯¹å€¼ >= 2%  æˆ–è€…
            //    - è¿ç»­æ¶¨è·Œå¤©æ•° >= 2å¤©
            const thresholdFunds = funds.filter(fund => 
                Math.abs(fund.daily_change_pct) >= THRESHOLDS.dailyChange || 
                fund.consecutive_days >= THRESHOLDS.consecutiveDays
            );
            
            // 2. æ ‡è®°åŸºé‡‘å±äºå“ªç§è¶…é˜ˆå€¼ç±»å‹
            thresholdFunds.forEach(fund => {
                const isDailyOver = Math.abs(fund.daily_change_pct) >= THRESHOLDS.dailyChange;
                const isConsecutiveOver = fund.consecutive_days >= THRESHOLDS.consecutiveDays;
                
                if (isDailyOver && isConsecutiveOver) {
                    fund.thresholdType = 'both'; // åŒæ—¶è¶…ä¸¤ä¸ªé˜ˆå€¼
                } else if (isDailyOver) {
                    fund.thresholdType = 'daily'; // ä»…å•æ—¥è¶…é˜ˆå€¼
                } else {
                    fund.thresholdType = 'consecutive'; // ä»…è¿ç»­è¶…é˜ˆå€¼
                }
            });
            
            // 3. æ’åºé€»è¾‘ï¼š
            //    - å…ˆæŒ‰å•æ—¥æ¶¨è·Œå¹…ç»å¯¹å€¼ä»å¤§åˆ°å°
            //    - å†æŒ‰è¿ç»­æ¶¨è·Œå¤©æ•°ä»å¤§åˆ°å°
            return thresholdFunds.sort((a, b) => {
                // æ¯”è¾ƒå•æ—¥æ¶¨è·Œå¹…ç»å¯¹å€¼
                const absA = Math.abs(a.daily_change_pct);
                const absB = Math.abs(b.daily_change_pct);
                if (absA !== absB) {
                    return absB - absA; // ç»å¯¹å€¼å¤§çš„æ’åœ¨å‰é¢
                }
                
                // å•æ—¥æ¶¨è·Œå¹…ç›¸åŒåˆ™æ¯”è¾ƒè¿ç»­å¤©æ•°
                return b.consecutive_days - a.consecutive_days;
            });
        }

        // æ¸²æŸ“è¶…é˜ˆå€¼åŸºé‡‘åˆ—è¡¨
        function renderFundList(thresholdFunds) {
            const container = document.getElementById('fundSignals');
            container.innerHTML = '';

            if (thresholdFunds.length > 0) {
                const section = document.createElement('div');
                section.className = 'group-section';
                section.innerHTML = `<div class="group-title">
                    ğŸ“Š è¶…é˜ˆå€¼åŸºé‡‘ï¼ˆ${thresholdFunds.length}åªï¼‰
                    <span style="font-size:14px; margin-left:10px;">
                        é˜ˆå€¼ï¼šå•æ—¥${THRESHOLDS.dailyChange}% / è¿ç»­${THRESHOLDS.consecutiveDays}å¤©
                    </span>
                </div>`;
                
                thresholdFunds.forEach(fund => {
                    section.appendChild(createFundItem(fund));
                });
                container.appendChild(section);
            } else {
                container.innerHTML = '<p>æš‚æ— è¶…é˜ˆå€¼çš„åŸºé‡‘æ•°æ®</p>';
            }
        }

        // åˆ›å»ºå•ä¸ªåŸºé‡‘é¡¹
        function createFundItem(fund) {
            const isRecorded = !!operationRecords[fund.code];
            const notes = operationRecords[fund.code]?.notes || '';

            // æ¶¨è·Œæ ·å¼
            let changeClass = 'flat';
            if (fund.daily_change_pct > 0) changeClass = 'rise';
            else if (fund.daily_change_pct < 0) changeClass = 'fall';

            // è¶…é˜ˆå€¼æ ‡ç­¾æ ·å¼
            let thresholdLabel = '';
            if (fund.thresholdType === 'daily') {
                thresholdLabel = '<span class="threshold-label daily-threshold">å•æ—¥è¶…é˜ˆå€¼</span>';
            } else if (fund.thresholdType === 'consecutive') {
                thresholdLabel = '<span class="threshold-label consecutive-threshold">è¿ç»­è¶…é˜ˆå€¼</span>';
            } else {
                thresholdLabel = '<span class="threshold-label both-threshold">åŒè¶…é˜ˆå€¼</span>';
            }

            const item = document.createElement('div');
            item.className = 'fund-item';
            item.innerHTML = `
                <!-- å·¦ä¾§ï¼šåŸºé‡‘åŸºæœ¬ä¿¡æ¯ -->
                <div class="fund-left">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" class="checkbox" data-code="${fund.code}" ${isRecorded ? 'checked' : ''}
                            onchange="toggleNotes('${fund.code}')">
                        <strong>${fund.name}</strong>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šæ¶¨è·Œå¹…ã€è¿ç»­å¤©æ•°ã€ç†ç”±å’Œæ“ä½œåŒº -->
                <div class="fund-right">
                    <div class="stat-info">
                        <span class="change-pct ${changeClass}">${fund.daily_change_pct.toFixed(2)}%</span>
                   
                        <span class="reason-text">${fund.reasons}</span>
                    </div>
                    
                    <!-- å¤‡æ³¨åŒºåŸŸ -->
                    <div class="notes-container" id="notes-${fund.code}" style="display: ${isRecorded ? 'block' : 'none'}">
                        <textarea class="notes-input" placeholder="è¯·è¾“å…¥æ“ä½œæ€è€ƒ...">${notes}</textarea>
                    </div>
                </div>
            `;
            
            // æ·»åŠ è‡ªåŠ¨ä¿å­˜äº‹ä»¶ç›‘å¬
            const notesInput = item.querySelector(`#notes-${fund.code} .notes-input`);
            notesInput.addEventListener('input', () => {
                saveNotes(fund.code);
            });
            
            return item;
        }

        // åˆ‡æ¢å¤‡æ³¨æ˜¾ç¤º/éšè—
        function toggleNotes(fundCode) {
            const notesContainer = document.getElementById(`notes-${fundCode}`);
            const isChecked = document.querySelector(`.checkbox[data-code="${fundCode}"]`).checked;
            
            if (isChecked) {
                notesContainer.style.display = 'block';
                if (!operationRecords[fundCode]) {
                    const fund = allFunds.find(f => f.code === fundCode);
                    operationRecords[fundCode] = {
                        name: fund.name,
                        notes: '',
                        date: new Date().toLocaleDateString()
                    };
                }
            } else {
                notesContainer.style.display = 'none';
            }
            updateRecordedCount();
            saveToLocalStorage();
        }

        // è‡ªåŠ¨ä¿å­˜å¤‡æ³¨
        function saveNotes(fundCode) {
            const notes = document.querySelector(`#notes-${fundCode} .notes-input`).value;
            if (operationRecords[fundCode]) {
                operationRecords[fundCode].notes = notes;
                operationRecords[fundCode].date = new Date().toLocaleDateString();
                saveToLocalStorage();
            }
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            localStorage.setItem('fundNotes', JSON.stringify(operationRecords));
            updateRecordedCount();
        }

        // æ›´æ–°è®°å½•æ•°é‡
        function updateRecordedCount() {
            document.getElementById('recordedCount').textContent = Object.keys(operationRecords).length;
        }

        // å¯¼å‡ºè®°å½•
        function exportRecords() {
            if (Object.keys(operationRecords).length === 0) {
                alert("æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•");
                return;
            }

            const today = new Date().toLocaleDateString();
            let content = `===== åŸºé‡‘æ“ä½œè®°å½•ï¼ˆ${today}ï¼‰=====\n\n`;
            
            Object.values(operationRecords).forEach(record => {
                content += `1. ${record.name}\n`;
                content += `   æ“ä½œï¼š${record.notes || 'æ— '}\n\n`;
            });

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `åŸºé‡‘æ“ä½œè®°å½•_${today.replace(/\//g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ¸…é™¤æ‰€æœ‰è®°å½•
        function clearAllRecords() {
            if (confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®°å½•å—ï¼Ÿ")) {
                operationRecords = {};
                localStorage.removeItem('fundNotes');
                const thresholdFunds = filterAndSortFunds(allFunds);
                renderFundList(thresholdFunds);
                updateRecordedCount();
            }
        }
    </script>
</body>
</html>
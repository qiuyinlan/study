<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>åŸºé‡‘ä¿¡å·åˆ†æå¹³å°</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .fund-list { margin-top: 20px; }
        .group-section { margin-bottom: 30px; }
        .group-title { 
            background-color: #e9f5ff; 
            padding: 10px 15px; 
            border-radius: 4px; 
            margin-bottom: 15px;
            font-size: 16px;
            color: #0066cc;
        }
        .fund-item { 
            padding: 15px; 
            border-bottom: 1px solid #eee; 
            margin-bottom: 10px;
            display: flex; /* å·¦å³å¸ƒå±€æ ¸å¿ƒ */
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .fund-left { flex: 1; min-width: 300px; } /* å·¦ä¾§ä¿¡æ¯ */
        .fund-right { flex: 2; min-width: 600px; } /* å³ä¾§ä¿¡å·å’Œæ“ä½œåŒº */
        .fund-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 8px;
        }
        .fund-item:hover { background-color: #f9f9f9; }
        .signal { padding: 5px 10px; border-radius: 3px; font-weight: bold; }
        .buy { background-color: #e6f7e9; color: #2a9d54; }
        .sell { background-color: #ffebe6; color: #d93025; }
        .watch { background-color: #fff8e6; color: #ff9800; }
        .none { background-color: #f0f0f0; color: #666; }
        .api-links { margin: 20px 0; padding: 10px; background-color: #f9f9f9; border-left: 3px solid #007bff; }
        .action-bar { margin: 20px 0; padding: 10px; background-color: #f0f8ff; display: flex; gap: 15px; align-items: center; }
        .export-btn, .clear-btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .export-btn { background-color: #007bff; color: white; }
        .export-btn:hover { background-color: #0056b3; }
        .clear-btn { background-color: #dc3545; color: white; }
        .clear-btn:hover { background-color: #bb2d3b; }
        .checkbox { width: 18px; height: 18px; cursor: pointer; margin-right: 10px; }
        .reason-text { color: #ff0000; margin-left: 15px; } /* ç†ç”±åœ¨å³ä¾§åŒºåŸŸå±•ç¤º */
        .change-pct { 
            padding: 3px 8px; 
            border-radius: 3px; 
            font-weight: 500; 
            margin-right: 15px;
        }
        .rise { color: #d93025; background-color: #fff1f0; }
        .fall { color: #0f9d58; background-color: #e6f4ea; }
        .flat { color: #666; background-color: #f5f5f5; }
        .notes-container { 
            margin-top: 8px; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 4px;
            display: none;
        }
        .notes-input { 
            width: 100%; 
            padding: 8px; 
            box-sizing: border-box; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            min-height: 60px;
            resize: vertical;
        }
        .notes-save {
            margin-top: 8px;
            padding: 5px 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .stat-info { display: flex; align-items: center; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>åŸºé‡‘ä¿¡å·åˆ†æå¹³å°</h1>
        <p>å®æ—¶å±•ç¤ºåŸºé‡‘æ¶¨è·Œæ•°æ®åŠæŠ•èµ„ä¿¡å·åˆ†æ</p>
    </div>

    <div class="api-links">
        <h3>API æ¥å£å‚è€ƒ</h3>
        <ul>
            <li>æ‰€æœ‰åŸºé‡‘åˆ—è¡¨ï¼š<a href="/api/funds" target="_blank">/api/funds</a></li>
            <li>æ‰€æœ‰åŸºé‡‘ä¿¡å·ï¼š<a href="/api/funds/signals" target="_blank">/api/funds/signals</a></li>
            <li>å•åªåŸºé‡‘è¯¦æƒ…ï¼ˆç¤ºä¾‹ï¼‰ï¼š<a href="/api/fund/019020" target="_blank">/api/fund/019020</a></li>
        </ul>
    </div>

    <div class="action-bar">
        <button class="export-btn" onclick="exportRecords()">å¯¼å‡ºæ“ä½œè®°å½•</button>
        <button class="clear-btn" onclick="clearAllRecords()">æ¸…é™¤æ‰€æœ‰è®°å½•</button>
        <span>å·²è®°å½• <span id="recordedCount">0</span> åªåŸºé‡‘</span>
    </div>

    <h2>åŸºé‡‘ä¿¡å·åˆ—è¡¨</h2>
    <div class="fund-list" id="fundSignals">
        <p>åŠ è½½ä¸­...</p>
    </div>

    <script>
        let operationRecords = JSON.parse(localStorage.getItem('fundNotes') || '{}');
        let allFunds = [];

        // ä»æ¥å£è·å–æ•°æ®åï¼Œå…ˆåˆ†ç»„æ’åºå†æ¸²æŸ“
        fetch('/api/funds/signals')
            .then(response => {
                if (!response.ok) throw new Error("æ•°æ®åŠ è½½å¤±è´¥");
                return response.json();
            })
            .then(data => {
                allFunds = data;
                const { thresholdFunds, normalFunds } = groupAndSortFunds(data); // åˆ†ç»„æ’åº
                renderFundList(thresholdFunds, normalFunds); // æ¸²æŸ“åˆ†ç»„åçš„åˆ—è¡¨
                updateRecordedCount();
            })
            .catch(error => {
                document.getElementById('fundSignals').innerHTML = `<p>é”™è¯¯ï¼š${error.message}</p>`;
            });

        // åˆ†ç»„å’Œæ’åºé€»è¾‘ï¼ˆæŒ‰æ¶¨è·Œå¹…é˜ˆå€¼åˆ†ç»„ï¼Œç»„å†…æŒ‰ç»å¯¹å€¼æ’åºï¼‰
        function groupAndSortFunds(funds) {
            // 1. åˆ†ç»„ï¼šè¶…é˜ˆå€¼ï¼ˆæ¶¨è·Œå¹…ç»å¯¹å€¼ >= 3%ï¼‰å’Œæ™®é€šåŸºé‡‘
            const thresholdFunds = funds.filter(fund => Math.abs(fund.daily_change_pct) >= 3);
            const normalFunds = funds.filter(fund => Math.abs(fund.daily_change_pct) < 3);

            // 2. ç»„å†…æ’åºï¼šæŒ‰æ¶¨è·Œå¹…ç»å¯¹å€¼ä»å¤§åˆ°å°
            const sortByChangeAbs = (a, b) => Math.abs(b.daily_change_pct) - Math.abs(a.daily_change_pct);
            
            return {
                thresholdFunds: thresholdFunds.sort(sortByChangeAbs),
                normalFunds: normalFunds.sort(sortByChangeAbs)
            };
        }

        // æ¸²æŸ“åˆ†ç»„åçš„åŸºé‡‘åˆ—è¡¨ï¼ˆå…ˆæ˜¾ç¤ºè¶…é˜ˆå€¼ç»„ï¼Œå†æ˜¾ç¤ºæ™®é€šç»„ï¼‰
        function renderFundList(thresholdFunds, normalFunds) {
            const container = document.getElementById('fundSignals');
            container.innerHTML = '';

            // 1. æ¸²æŸ“è¶…é˜ˆå€¼ç»„
            if (thresholdFunds.length > 0) {
                const thresholdSection = document.createElement('div');
                thresholdSection.className = 'group-section';
                thresholdSection.innerHTML = `<div class="group-title">ğŸ“Š å•æ—¥æ¶¨è·Œè¶…é˜ˆå€¼ï¼ˆ${thresholdFunds.length}åªï¼‰</div>`;
                thresholdFunds.forEach(fund => {
                    thresholdSection.appendChild(createFundItem(fund));
                });
                container.appendChild(thresholdSection);
            }

            // 2. æ¸²æŸ“æ™®é€šç»„
            if (normalFunds.length > 0) {
                const normalSection = document.createElement('div');
                normalSection.className = 'group-section';
                normalSection.innerHTML = `<div class="group-title">ğŸ“‹ æ™®é€šæ¶¨è·ŒåŸºé‡‘ï¼ˆ${normalFunds.length}åªï¼‰</div>`;
                normalFunds.forEach(fund => {
                    normalSection.appendChild(createFundItem(fund));
                });
                container.appendChild(normalSection);
            }
        }

        // åˆ›å»ºå•ä¸ªåŸºé‡‘é¡¹ï¼ˆå·¦å³å¸ƒå±€ï¼‰
        function createFundItem(fund) {
            const isRecorded = !!operationRecords[fund.code];
            const notes = operationRecords[fund.code]?.notes || '';

            let changeClass = 'flat';
            if (fund.daily_change_pct > 0) changeClass = 'rise';
            else if (fund.daily_change_pct < 0) changeClass = 'fall';

            const item = document.createElement('div');
            item.className = 'fund-item';
            item.innerHTML = `
                <!-- å·¦ä¾§ï¼šåŸºé‡‘åŸºæœ¬ä¿¡æ¯ -->
                <div class="fund-left">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" class="checkbox" data-code="${fund.code}" ${isRecorded ? 'checked' : ''}
                            onchange="toggleNotes('${fund.code}')">
                        <strong>${fund.name}</strong>ï¼ˆ${fund.code}ï¼‰
                    </div>
                </div>

                <!-- å³ä¾§ï¼šä¿¡å·ã€æ¶¨è·Œå¹…ã€ç†ç”±å’Œæ“ä½œåŒº -->
                <div class="fund-right">
                    <div class="stat-info">
                        <span class="change-pct ${changeClass}">${fund.daily_change_pct.toFixed(2)}%</span>
                        <span>è¿ç»­${fund.consecutive_days}å¤©</span>
                        <span class="reason-text">${fund.reasons}</span>
                    </div>
                    
                    <!-- å¤‡æ³¨åŒºåŸŸ -->
                    <div class="notes-container" id="notes-${fund.code}" style="display: ${isRecorded ? 'block' : 'none'}">
                        <textarea class="notes-input" placeholder="è¯·è¾“å…¥æ“ä½œæ€è€ƒ...">${notes}</textarea>
                        <button class="notes-save" onclick="saveNotes('${fund.code}')">ä¿å­˜å¤‡æ³¨</button>
                    </div>
                </div>
            `;
            return item;
        }

        // åˆ‡æ¢å¤‡æ³¨æ˜¾ç¤º/éšè—ï¼ˆå¤ç”¨ä½ çš„é€»è¾‘ï¼‰
        function toggleNotes(fundCode) {
            const notesContainer = document.getElementById(`notes-${fundCode}`);
            const isChecked = document.querySelector(`.checkbox[data-code="${fundCode}"]`).checked;
            
            if (isChecked) {
                notesContainer.style.display = 'block';
                if (!operationRecords[fundCode]) {
                    const fund = allFunds.find(f => f.code === fundCode);
                    operationRecords[fundCode] = {
                        name: fund.name,
                        notes: '',
                        date: new Date().toLocaleDateString()
                    };
                }
            } else {
                notesContainer.style.display = 'none';
            }
            updateRecordedCount();
            saveToLocalStorage();
        }

        // ä¿å­˜å¤‡æ³¨ï¼ˆå¤ç”¨ä½ çš„é€»è¾‘ï¼‰
        function saveNotes(fundCode) {
            const notes = document.querySelector(`#notes-${fundCode} .notes-input`).value;
            if (operationRecords[fundCode]) {
                operationRecords[fundCode].notes = notes;
                operationRecords[fundCode].date = new Date().toLocaleDateString();
                saveToLocalStorage();
                alert("å¤‡æ³¨å·²ä¿å­˜");
            }
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            localStorage.setItem('fundNotes', JSON.stringify(operationRecords));
            updateRecordedCount();
        }

        // æ›´æ–°è®°å½•æ•°é‡
        function updateRecordedCount() {
            document.getElementById('recordedCount').textContent = Object.keys(operationRecords).length;
        }

        // å¯¼å‡ºè®°å½•ï¼ˆä»…åŸºé‡‘åç§°+æ“ä½œï¼‰
        function exportRecords() {
            if (Object.keys(operationRecords).length === 0) {
                alert("æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•");
                return;
            }

            const today = new Date().toLocaleDateString();
            let content = `===== åŸºé‡‘æ“ä½œè®°å½•ï¼ˆ${today}ï¼‰=====\n\n`;
            
            Object.values(operationRecords).forEach(record => {
                content += `1. ${record.name}\n`;
                content += `   æ“ä½œï¼š${record.notes || 'æ— '}\n\n`;
            });

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `åŸºé‡‘æ“ä½œè®°å½•_${today.replace(/\//g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ¸…é™¤æ‰€æœ‰è®°å½•
        function clearAllRecords() {
            if (confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®°å½•å—ï¼Ÿ")) {
                operationRecords = {};
                localStorage.removeItem('fundNotes');
                // é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆä¿æŒåˆ†ç»„æ’åºï¼‰
                const { thresholdFunds, normalFunds } = groupAndSortFunds(allFunds);
                renderFundList(thresholdFunds, normalFunds);
                updateRecordedCount();
            }
        }
    </script>
</body>
</html>